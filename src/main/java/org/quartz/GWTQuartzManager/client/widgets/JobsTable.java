package org.quartz.GWTQuartzManager.client.widgets;

import java.util.ArrayList;
import java.util.Date;

import org.quartz.GWTQuartzManager.client.EditJobDetailWorkflow;
import org.quartz.GWTQuartzManager.client.events.DeleteJobEvent;
import org.quartz.GWTQuartzManager.client.events.EditJobEvent;
import org.quartz.GWTQuartzManager.client.events.EditTriggerEvent;
import org.quartz.GWTQuartzManager.client.events.TriggerJobEvent;
import org.quartz.GWTQuartzManager.share.GWTCronTrigger;
import org.quartz.GWTQuartzManager.share.GWTJobDetail;
import org.quartz.GWTQuartzManager.share.GWTKey;
import org.quartz.GWTQuartzManager.share.Pair;

import com.google.gwt.cell.client.ButtonCell;
import com.google.gwt.cell.client.FieldUpdater;
import com.google.gwt.core.client.GWT;
import com.google.gwt.event.shared.EventBus;
import com.google.gwt.uibinder.client.UiBinder;
import com.google.gwt.uibinder.client.UiField;
import com.google.gwt.user.cellview.client.CellTable;
import com.google.gwt.user.cellview.client.Column;
import com.google.gwt.user.cellview.client.DataGrid;
import com.google.gwt.user.cellview.client.TextColumn;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.Widget;
import com.google.gwt.view.client.ListDataProvider;

public class JobsTable extends Composite {

	@UiField(provided=true) 
	DataGrid<GWTJobDetail> table = new DataGrid<GWTJobDetail>();

	interface JobsTableBinder extends UiBinder<Widget, JobsTable> {
	}

	final EventBus eventBus;
	
	public JobsTable(ListDataProvider<GWTJobDetail> jobsProvider, final EventBus eventBus) {
		this.eventBus = eventBus;
	
		
				
		TextColumn<GWTJobDetail> tcName = new TextColumn<GWTJobDetail>() {
			@Override
			public String getValue(GWTJobDetail object) {
				return object.getKey().getName();
			}
		};
		table.addColumn(tcName, "Name");
		
		TextColumn<GWTJobDetail> tcGroup = new TextColumn<GWTJobDetail>() {
			@Override
			public String getValue(GWTJobDetail object) {
				return object.getKey().getGroup();
			}
		};
		table.addColumn(tcGroup, "Group");
		
		jobsProvider.addDataDisplay(table);
		
		TextColumn<GWTJobDetail> tcDescription = new TextColumn<GWTJobDetail>() {
			@Override
			public String getValue(GWTJobDetail object) {
				return object.getDescription();
			}
		};
		table.addColumn(tcDescription, "description");
		
		TextColumn<GWTJobDetail> tcJobClass = new TextColumn<GWTJobDetail>() {
			@Override
			public String getValue(GWTJobDetail object) {
				return object.getJobClassName();
			}
		};
		table.addColumn(tcJobClass, "jobClass name");
		
		TextColumn<GWTJobDetail> tcJobDataMap = new TextColumn<GWTJobDetail>() {
			@Override
			public String getValue(GWTJobDetail object) {
				return object.getJobDataMapEntryList().toString();
			}
		};
		table.addColumn(tcJobDataMap, "jobDataMap");
		
		Column<GWTJobDetail, String> cTrigger = new Column<GWTJobDetail, String>(new ButtonCell()) {
			@Override
			public String getValue(GWTJobDetail object) {
				
				return null;
			}
			
		};
		
		cTrigger.setFieldUpdater(new FieldUpdater<GWTJobDetail, String>() {
			
			@Override
			public void update(int index, GWTJobDetail object, String value) {
				eventBus.fireEvent(new TriggerJobEvent(object));
			}
		});
		
		table.addColumn(cTrigger, "trigger");
		
		Column<GWTJobDetail, String> cDelete = new Column<GWTJobDetail, String>(new ButtonCell()) {
			@Override
			public String getValue(GWTJobDetail object) {
				return null;
			}
		};
		cDelete.setFieldUpdater(new FieldUpdater<GWTJobDetail, String>() {

			@Override
			public void update(int index, GWTJobDetail object, String value) {
				eventBus.fireEvent(new DeleteJobEvent(object));
			}
		});
		table.addColumn(cDelete, "delete");
		
		Column<GWTJobDetail, String> newTrigger = new Column<GWTJobDetail, String>(new ButtonCell()) {
			@Override
			public String getValue(GWTJobDetail object) {
				return (String) null;
			}
		};
		newTrigger.setFieldUpdater(new FieldUpdater<GWTJobDetail, String>() {

			@Override
			public void update(int index, GWTJobDetail object, String value) {
				GWTCronTrigger trigger = new GWTCronTrigger();
				trigger.setKey(new GWTKey(object.getKey().getName(), object.getKey().getGroup()));
				trigger.setJobKey(new GWTKey(object.getKey().getName(), object.getKey().getGroup()));
				trigger.setStartTime(new Date());
				trigger.setJobDataMapEntryList((ArrayList<Pair<String,String>>)object.getJobDataMapEntryList().clone());
				eventBus.fireEvent(new EditTriggerEvent(trigger));
			}
		});
		table.addColumn(newTrigger, "new trigger");
		
		Column<GWTJobDetail, String> newJob = new Column<GWTJobDetail, String>(new ButtonCell()) {

			@Override
			public String getValue(GWTJobDetail object) {
				return null;
			}
		};
		newJob.setFieldUpdater(new FieldUpdater<GWTJobDetail, String>() {
			
			@Override
			public void update(int index, GWTJobDetail object, String value) {
				eventBus.fireEvent(new EditJobEvent(object, false));
			}
		});
		table.addColumn(newJob, "edit");
		
		initWidget(GWT.<JobsTableBinder>create(JobsTableBinder.class).createAndBindUi(this));
	}

}
